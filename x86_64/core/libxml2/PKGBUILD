pkgname=libxml2
pkgver=2.9.12
pkgrel=5
arch=('x86_64')
depends=(icu readline zlib ncurses xz)
makedepends=(python3)
source=(http://xmlsoft.org/sources/$pkgname-$pkgver.tar.gz)

build() {
	cd $pkgname-$pkgver

	# fix a problem generating the Python3 module with Python-3.9.0 and later
	sed -i '/if Py/{s/Py/(Py/;s/)/))/}' python/{types.c,libxml.c}

	# ensure that the Python module can be built by Python-3.9.0
	sed -i '/_PyVerify_fd/,+1d' python/types.c

	./configure \
	--prefix=/usr    \
	--disable-static \
	--with-history   \
	--with-icu \
	--with-threads \
	--with-python=/usr/bin/python

	make
}

package() {
        cd $pkgname-$pkgver

	make DESTDIR=$pkgdir install

	python -m compileall -d /usr/lib "$pkgdir/usr/lib"
	python -O -m compileall -d /usr/lib "$pkgdir/usr/lib"
}
