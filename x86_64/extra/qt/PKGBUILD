pkgname=qt
pkgver=5.15.2
pkgrel=1
arch=('x86_64')
depends=(xorg-server cups glib2 icu harfbuzz libjpeg libpng libtiff sqlite3 libinput python3 pulseaudio)
makedepends=(extra-cmake-modules)
source=(https://download.qt.io/archive/$pkgname/5.15/$pkgver/single/qt-everywhere-src-$pkgver.tar.xz
	qt-everywhere-src-5.15.2-CVE-2021-3481-1.patch
	assistant-qt5.desktop
	designer-qt5.desktop
	linguist-qt5.desktop
	qdbusviewer-qt5.desktop)

prepare() {
	cd qt-everywhere-src-$pkgver

	patch -Np1 -i ../qt-everywhere-src-5.15.2-CVE-2021-3481-1.patch
}

build() {
	cd qt-everywhere-src-$pkgver

	# BLFS recommendation to use /opt instead /usr
	export QT5PREFIX=/opt/qt5

	# fix some issues using gcc-11
	sed -i '/utility/a #include <limits>'     qtbase/src/corelib/global/qglobal.h
	sed -i '/string/a #include <limits>'      qtbase/src/corelib/global/qfloat16.h
	sed -i '/qbytearray/a #include <limits>'  qtbase/src/corelib/text/qbytearraymatcher.h
	sed -i '/type_traits/a #include <limits>' qtdeclarative/src/qmldebug/qqmlprofilerevent_p.h

	./configure			\
	-prefix $QT5PREFIX		\
	-sysconfdir /etc/xdg		\
	-confirm-license		\
	-opensource			\
	-dbus-linked			\
	-system-harfbuzz		\
	-system-sqlite			\
	-nomake examples		\
	-no-rpath			\
	-journald			\
	-skip qtwebengine

	make
}

package() {
	cd qt-everywhere-src-$pkgver

	# Sometimes, the installation paths are hardcoded into installed files.
	# This is the reason why /opt/qt5 is used as
	# installation prefix instead of /opt/qt-5.15.2.
	mkdir -pv $pkgdir/opt/qt-5.15.2
	ln -sfnv qt-5.15.2 $pkgdir/opt/qt5

	make DESTDIR=$pkgdir install

	# Remove references to the build directory from installed library dependency (prl)
	find $pkgdir/$QT5PREFIX/ -name \*.prl \
		-exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \;

	# Install images and create the menu entries for installed applications.
	install -v -dm755 $pkgdir/usr/share/pixmaps/
	install -v -Dm644 qttools/src/assistant/assistant/images/assistant-128.png \
		$pkgdir/usr/share/pixmaps/assistant-qt5.png
	install -v -Dm644 qttools/src/designer/src/designer/images/designer.png \
		$pkgdir/usr/share/pixmaps/designer-qt5.png
	install -v -Dm644 qttools/src/linguist/linguist/images/icons/linguist-128-32.png \
		$pkgdir/usr/share/pixmaps/linguist-qt5.png
	install -v -Dm644 qttools/src/qdbus/qdbusviewer/images/qdbusviewer-128.png \
		$pkgdir/usr/share/pixmaps/qdbusviewer-qt5.png
	install -dm755 /usr/share/applications

	cp $srcdir/assistant-qt5.desktop /usr/share/applications/
	cp $srcdir/designer-qt5.desktop /usr/share/applications/
	cp $srcdir/linguist-qt5.desktop /usr/share/applications/
	cp $srcdir/qdbusviewer-qt5.desktop /usr/share/applications/

	# Some packages such as VLC look for certain executables with a -qt5 suffix
	for file in moc uic rcc qmake lconvert lrelease lupdate; do
		ln -sfrvn $pkgdir/opt/qt-5.15.2/bin/$file /usr/bin/$file-qt5
	done
}
