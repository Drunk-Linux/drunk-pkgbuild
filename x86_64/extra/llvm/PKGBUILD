# Description: Utilities to administer Access Control Lists, which are used to define more fine-grained discretionary access rights for files and directories
# URL:         http://savannah.nongnu.org/projects/acl
# Maintainer:  Emmett1, emmett1 dot 2miligrams at gmail dot com
# Depends on:  

pkgname=llvm
pkgver=13.0.0
pkgrel=1
makedepends=('cmake' 'python3' 'drunk-base')
arch=('x86_64')
psource=https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver
source=($psource/$pkgname-$pkgver.src.tar.xz
	01.patch
	02.patch
	03.patch
	llvm-config.h)

prepare() {
	cd $pkgname-$pkgver.src
	mkdir -p build
	
	# https://github.com/intel/intel-graphics-compiler/issues/204
	patch -Rp2 -i ../01.patch
	# Work around intermittent 'clang -0 -g' crashes
	patch -Np2 -i ../02.patch
	# Fix an ISPC build failure (https://github.com/ispc/ispc/issues/2189)
	patch -Np2 -i ../03.patch
}

build() {
        cd $pkgname-$pkgver.src/build
	
	cmake .. -G Ninja		\
	-DMAKE_BUILD_TYPE=Release	\
	-DMAKE_INSTALL_PREFIX=/usr	\
	-DLLVM_BUILD_LLVM_DYLIB=ON	\
	-DLLVM_LINK_LLVM_DYLIB=ON	\
	-DLLVM_INSTALL_UTILS=ON		\
	-DLLVM_ENABLE_RTTI=ON		\
	-DLLVM_ENABLE_FFI=ON		\
	-DLLVM_BUILD_TESTS=OFF		\
	-DLLVM_BUILD_DOCS=OFF		\
	-DLLVM_BINUTILS_INCDIR=/usr/include
}

package() {
	cd $pkgname-$pkgver.src/build

	DESTDIR=$pkgdir ninja install

	pushd ../utils/lit
        python3 setup.py install --root="$pkgdir" -O1
        popd

        install -d "$pkgdir/usr/lib/bfd-plugins"
        ln -s ../LLVMgold.so "$pkgdir/usr/lib/bfd-plugins/LLVMgold.so"	
}
