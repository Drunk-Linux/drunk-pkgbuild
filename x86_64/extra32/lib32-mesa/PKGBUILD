pkgname=lib32-mesa
rpkgname=mesa
pkgver=21.3.2
pkgrel=4
arch=('x86_64')
depends=('glibc')
source=(https://mesa.freedesktop.org/archive/mesa-$pkgver.tar.xz)
makedepends=('clang' 'cmake')
prepare() {
	cd mesa-$pkgver

	pip install setuptools
	echo "[!]: Installing mako with pip"
	pip install mako
}

build() {
        cd mesa-$pkgver

	sed '1s/python/&3/' -i bin/symbols-check.py

	mkdir -p build && cd build

	export CC="gcc -m32"
	export CXX="g++ -m32"
	export PKG_CONFIG="i686-pc-linux-gnu-pkg-config"
	cat >crossfile.ini <<END
[binaries]
llvm-config = '/usr/bin/llvm-config32'
END

	meson				\
	--native-file crossfile.ini	\
	--prefix=/usr			\
	--buildtype=release		\
	--libexecdir=/usr/lib32		\
	-D platforms=wayland,x11 	\
	..

	ninja
}

package() {
	cd mesa-$pkgver/build
	DESTDIR=$pkgdir ninja install
}
