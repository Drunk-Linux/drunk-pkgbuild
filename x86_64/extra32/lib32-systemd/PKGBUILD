pkgname=lib32-systemd
rname=systemd
pkgver=250.2
pkgrel=1
arch=('x86_64')
depends=('lib32-acl' 'docbook-xsl' 'gperf' 'lib32-lz4' 'lib32-xz' 'lib32-linux-pam' 'lib32-elfutils'
	'intltool' 'kmod' 'lib32-libcap' 'lib32-libidn2' 'lib32-libgcrypt'
	'lib32-libxslt' 'lib32-util-linux'
	'shadow' 'gnu-efi' 'git'
	'meson' 'lib32-libxkbcommon'
	'bash-completion' 'lib32-p11-kit' 'rsync')
makedepends=(python3-pip)
source=("https://github.com/systemd/systemd-stable/archive/refs/tags/v${pkgver}.tar.gz")

prepare() {
	pip install setuptools

	pip install jinja2

        cd $rname-stable-$pkgver
        
        sed -i -e 's/GROUP="render"/GROUP="video"/' \
        -e 's/GROUP="sgx", //' rules.d/50-udev-default.rules.in
        
        sed -i 's/+ want_libfuzzer.*$/and want_libfuzzer/' meson.build
}

build() {
	cd $rname-stable-$pkgver        
        mkdir -p build
	cd build

	export CC="gcc -m32"
	export CXX="g++ -m32"
	export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

	export PATH=/bin:/sbin:/usr/bin:/usr/sbin:$PATH	
	LANG=en_US.UTF-8						\
	meson								\
		--prefix=/usr						\
		--libexecdir=/usr/lib32					\
		--libdir=/usr/lib32					\
		--sysconfdir=/etc					\
		--localstatedir=/var					\
		--buildtype=release					\
		-D blkid=true						\
		-D mode=release						\
		-D default-hierarchy=unified				\
		-D install-tests=false					\
		-D docdir=/usr/share/doc/systemd-249			\
		-D dbuspolicydir=/usr/share/dbus-1/system.d		\
		-D sbat-distro='drunk'					\
		-D sbat-distro-summary='Drunk Linux'			\
		-D sbat-distro-pkgname="${pkgname}"			\
		-D sbat-distro-version="${pkgver}"			\
		-D sbat-distro-url="http://drunk.epizy.com/"		\
		..

	ninja
}

package() {
	cd $rname-stable-$pkgver/build
	
	LANG=en_US.UTF-8 ninja
	LANG=en_US.UTF-8 DESTDIR=$pkgdir PREFIX=$pkgdir ninja install

	rm -rf $pkgdir/usr/{bin,sbin,share,include}
}
