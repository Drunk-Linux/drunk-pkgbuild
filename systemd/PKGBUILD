# Description: The systemd package contains programs for controlling the startup, running, and shutdown of the system. 
# URL:         https://systemd.io
# Maintainer:  none
# Depends on:  

pkgname=systemd
pkgver=249
pkgrel=4
arch=('x86_64')
source=("https://ftp.osuosl.org/pub/lfs/lfs-packages/11.0/systemd-${pkgver}.tar.gz"
	'drunk.conf'
	'initrd-drunk.conf'
	'loader.conf'
	'BOOTX64.EFI'
	'systemd-bootx64.efi')

build() {
        cd $pkgname-$pkgver

        wget https://ftp.osuosl.org/pub/lfs/lfs-packages/11.0/systemd-249-upstream_fixes-1.patch
#        patch -Np1 -i systemd-249-upstream_fixes-1.patch
        rm -f systemd-249-upstream_fixes-1.patch
        
        sed -i -e 's/GROUP="render"/GROUP="video"/' \
        -e 's/GROUP="sgx", //' rules.d/50-udev-default.rules.in
        
        sed -i 's/+ want_libfuzzer.*$/and want_libfuzzer/' meson.build
        sed -i '/ARPHRD_CAN/a#define ARPHRD_MCTP        290' src/basic/linux/if_arp.h
        
        mkdir -p build
	cd build
	export PATH=/bin:/sbin:/usr/bin:/usr/sbin:$PATH	
	LANG=en_US.UTF-8                    \
	meson --prefix=/usr                 \
		--sysconfdir=/etc             \
		--localstatedir=/var          \
		--buildtype=release           \
		-Dblkid=true                  \
		-Dmode=release                \
		-Dinstall-tests=false	      \
		-Ddocdir=/usr/share/doc/systemd-249 \
		..
}

package() {
	install -D -m0644 drunk.conf "$pkgdir"/usr/share/systemd/bootctl/drunk.conf
	install -D -m0644 drunk.conf "$pkgdir"/usr/share/systemd/bootctl/initrd-drunk.conf
        install -D -m0644 loader.conf "$pkgdir"/usr/share/systemd/bootctl/loader.conf


        cd $pkgname-$pkgver
	cd build
	
	mkdir -p $pkgdir/usr/lib/systemd/boot/efi
	cp -rf $srcdir/BOOTX64.EFI $pkgdir/usr/lib/systemd/boot/
	cp -rf $srcdir/systemd-bootx64.efi $pkgdir/usr/lib/systemd/boot/
	
	LANG=en_US.UTF-8 ninja
	LANG=en_US.UTF-8 DESTDIR=$pkgdir PREFIX=$pkgdir ninja install

	# Copy example .config files
	#install -D -m0644 ../../drunk.conf "$pkgdir"/usr/share/systemd/bootctl/drunk.conf
	#install -D -m0644 ../../loader.conf "$pkgdir"/usr/share/systemd/bootctl/loader.conf
}
