# Description: Utilities to administer Access Control Lists, which are used to define more fine-grained discretionary access rights for files and directories
# URL:         http://savannah.nongnu.org/projects/acl
# Maintainer:  Emmett1, emmett1 dot 2miligrams at gmail dot com
# Depends on:  

pkgname=mesa
pkgver=21.2.1
pkgrel=3
arch=('x86_64')
depends=('libxcb' 'fontconfig' 'libdrm' 'libx11' 'libxext' 'libxfixes' 'libxshmfence' 'libxrender'
	'wayland' 'wayland-protocols' 'llvm' 'vulkan-icd-loader' 'libomxil-bellagio' 'libclc'
	'valgrind' 'libunwind' 'vulkan-icd-loader' 'libpciaccess' 'libxxf86vm')
source=(https://mesa.freedesktop.org/archive/$pkgname-$pkgver.tar.xz
	swr-llvm13-patch1.patch
	swr-llvm13-patch2.patch)
makedepend=('clang' 'cmake')
prepare() {
	cd $pkgname-$pkgver

	patch -Np1 -i $srcdir/swr-llvm13-patch1.patch
	patch -Np1 -i $srcdir/swr-llvm13-patch2.patch
}

build() {
        cd $pkgname-$pkgver

	sed '1s/python/&3/' -i bin/symbols-check.py

	mkdir -p build && cd build

	meson			\
	--prefix=/usr		\
	--buildtype=release	\
	-D gallium-nine=true	\
	-D glx=dri		\
	-D libunwind=enabled	\
	-D platforms=wayland,x11 \
	-D gles1=enabled	\
	-D gles2=enabled	\
	-D llvm=enabled		\
	-D osmesa=true		\
	-D shared-glapi=enabled	\
	-D valgrind=enabled	\
	-D gallium-drivers=r300,r600,radeonsi,nouveau,virgl,svga,swrast,swr,iris,crocus,zink	\
	-D dri-drivers=i915,i965,r100,r200,nouveau	\
	-D egl=enabled		\
	-D dri3=enabled
	-D gallium-extra-hud=true			\
	-D gallium-omx=bellagio	\
	-D gallium-opencl=icd	\
	-D gallium-va=disabled	\
	-D gallium-xa=disabled	\
	-D gallium-xvmc=disabled	\
	..

	unset GALLIUM_DRV DRI_DRIVERS

	ninja
}

package() {
	cd $pkgname-$pkgver/build
	DESTDIR=$pkgdir ninja install
}
