# Description: The main C library
# URL:         
# Maintainer:  Emmett1, emmett1 dot 2miligrams at gmail dot com
# Depends on:  

pkgname=glibc
pkgver=2.33
pkgrel=3
arch=('x86_64')
source=(https://ftp.gnu.org/gnu/$pkgname/$pkgname-$pkgver.tar.xz
	$pkgname-fhs-1.patch)

build() {
	cd $pkgname-$pkgver

#	patch -Np1 -i ../$pkgname-fhs-1.patch

	mkdir -pv build
	cd       build

	../configure                                        \
	             --prefix=/usr                          \
	             --disable-werror                       \
	             --enable-kernel=3.2                    \
	             --enable-stack-protector=strong        \
	             --with-headers=/usr/include            \
	             --enable-multi-arch                    \
	             libc_cv_slibdir=/lib
	make
	
	mkdir -p ../build32
	cd ../build32
	CC="gcc -m32" \
	CXX="g++ -m32" \
	../configure --prefix=/usr                   \
	             --disable-werror                \
	             --enable-kernel=3.2             \
	             --enable-multi-arch             \
	             --enable-stack-protector=strong \
	             --libdir=/usr/lib32             \
		     --libexecdir=/usr/lib32         \
	             libc_cv_slibdir=/usr/lib32      \
	             i686-pc-linux-gnu
	make

}

package() {
        # 64bit install
        cd $pkgname-$pkgver
        cd build

        mkdir -p $pkgdir/lib64
        ln -sfv ../lib/ld-linux-x86-64.so.2 $pkgdir/lib64/ld-linux-x86-64.so.2
        ln -sfv ../lib/ld-linux-x86-64.so.2 $pkgdir/lib64/ld-lsb-x86-64.so.3

        mkdir -p $pkgdir/etc
        touch $pkgdir/etc/ld.so.conf
        make install_root=$pkgdir install

        cp -v ../nscd/nscd.conf $pkgdir/etc/nscd.conf
        mkdir -pv $pkgdir/var/cache/nscd

        mkdir -pv $pkgdir/usr/lib/locale
        make install_root=$pkgdir localedata/install-locales

        

	# 32bit
	cd ../build32	
	
	rm -rf DESTDIR	
	mkdir -p DESTDIR/usr/lib32/
	sleep 10
	ls DESTDIR
	make install_root=$('pwd')/DESTDIR install
	ls DESTDIR/
	
	install -vdm755 $pkgdir/usr/lib32
	install -vdm755 $pkgdir/include/gnu
	install -vdm755 $pkgdir/etc/ld.so.conf.d
	
	mkdir -vp $pkgdir/usr/lib32/
	cp -Rv DESTDIR/usr/lib32/* $pkgdir/usr/lib32/

	mkdir -vp $pkgdir/etc/ld.so.conf.d
	mkdir -vp $pkgdir/lib/

	ln -sv ../usr/lib32/ld-linux.so.2 $pkgdir/lib/ld-linux.so.2
	ln -sv ../usr/lib32/ld-linux.so.2 $pkgdir/lib/ld-lsb.so.3
	ln -sv ../lib/locale $pkgdir/usr/lib32/locale
	echo "/usr/lib32" > $pkgdir/etc/ld.so.conf.d/lib32.conf
	cd -

	cat > $pkgdir/etc/nsswitch.conf << "EOF"
# Begin /etc/nsswitch.conf

passwd: files
group: files
shadow: files

hosts: files dns
networks: files

protocols: files
services: files
ethers: files
rpc: files

# End /etc/nsswitch.conf
EOF

cat > $pkgdir/etc/ld.so.conf << "EOF"
# Begin /etc/ld.so.conf
/usr/local/lib
/opt/lib

EOF

cat >> $pkgdir/etc/ld.so.conf << "EOF"
# Add an include directory
include /etc/ld.so.conf.d/*.conf

EOF
	mkdir -pv $pkgdir/etc/ld.so.conf.d
	
}
