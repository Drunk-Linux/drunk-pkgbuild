# Description: The systemd package contains programs for controlling the startup, running, and shutdown of the system. 
# URL:         https://systemd.io
# Maintainer:  none
# Depends on:  

pkgname=systemd
pkgver=249
pkgrel=7
arch=('x86_64')
depends=(polkit linux-pam libxkbcommon)
source=("https://ftp.osuosl.org/pub/lfs/lfs-packages/11.0/systemd-${pkgver}.tar.gz"
	'drunk.conf'
	'initrd-drunk.conf'
	'loader.conf'
	'linuxx64.efi.stub'
	'systemd-bootx64.efi'
	'systemd-user.pam'
	'systemd-hook'
	'20-systemd-sysusers.hook'
	'30-systemd-binfmt.hook'
	'30-systemd-catalog.hook'
	'30-systemd-daemon-reload.hook'
	'30-systemd-hwdb.hook'
	'30-systemd-sysctl.hook'
	'30-systemd-tmpfiles.hook'
	'30-systemd-udev-reload.hook'
	'30-systemd-update.hook')

backup=(etc/pam.d/systemd-user
	etc/systemd/coredump.conf
	etc/systemd/homed.conf
	etc/systemd/journald.conf
	etc/systemd/journal-remote.conf
	etc/systemd/journal-upload.conf
	etc/systemd/logind.conf
	etc/systemd/networkd.conf)

build() {
        cd $pkgname-$pkgver

        wget https://ftp.osuosl.org/pub/lfs/lfs-packages/11.0/systemd-249-upstream_fixes-1.patch
#        patch -Np1 -i systemd-249-upstream_fixes-1.patch
        rm -f systemd-249-upstream_fixes-1.patch
        
        sed -i -e 's/GROUP="render"/GROUP="video"/' \
        -e 's/GROUP="sgx", //' rules.d/50-udev-default.rules.in
        
        sed -i 's/+ want_libfuzzer.*$/and want_libfuzzer/' meson.build
        sed -i '/ARPHRD_CAN/a#define ARPHRD_MCTP        290' src/basic/linux/if_arp.h
        
        mkdir -p build
	cd build
	export PATH=/bin:/sbin:/usr/bin:/usr/sbin:$PATH	
	LANG=en_US.UTF-8                    \
	meson --prefix=/usr                 \
		--sysconfdir=/etc             \
		--localstatedir=/var          \
		--buildtype=release           \
		-D blkid=true                  \
		-D mode=release                \
		-D install-tests=false	      \
		-D docdir=/usr/share/doc/systemd-249 \
		-D dbuspolicydir=/usr/share/dbus-1/system.d \
		..
}

package() {
	install -D -m0644 drunk.conf "$pkgdir"/usr/share/systemd/bootctl/drunk.conf
	install -D -m0644 drunk.conf "$pkgdir"/usr/share/systemd/bootctl/initrd-drunk.conf
        install -D -m0644 loader.conf "$pkgdir"/usr/share/systemd/bootctl/loader.conf


        cd $pkgname-$pkgver
	cd build
	
	mkdir -p $pkgdir/usr/lib/systemd/boot/efi
	cp -rf $srcdir/linuxx64.efi.stub $pkgdir/usr/lib/systemd/boot/efi/
	cp -rf $srcdir/systemd-bootx64.efi $pkgdir/usr/lib/systemd/boot/efi/
	
	LANG=en_US.UTF-8 ninja
	LANG=en_US.UTF-8 DESTDIR=$pkgdir PREFIX=$pkgdir ninja install

	install -D -m0644 $srcdir/systemd-user.pam $pkgdir/etc/pam.d/systemd-user
	install -D -m0755 $srcdir/systemd-hook $pkgdir/usr/share/libalpm/scripts/systemd-hook
	install -D -m0644 -t $pkgdir/usr/share/libalpm/hooks $srcdir/*.hook
	install -d -o root -g 102 0m 0750 $pkgdir/usr/share/polkit-1/rules.d
	install -d -o root -g root -m 2755 $pkgdir/var/log/journal
}
